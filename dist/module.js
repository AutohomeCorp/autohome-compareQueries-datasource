define(["lodash","moment","@grafana/data","app/plugins/sdk"],(function(t,e,r,n){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/",r(r.s=4)}([function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e,r){"use strict";r.r(e);var n=r(0),i=r.n(n),a=r(1),o=r.n(a),u=r(2),f=function(){function t(t,e,r){this.units=["y","M","w","d","h","m","s"],this.datasourceSrv=e,this.$q=t,this.templateSrv=r}return t.$inject=["$q","datasourceSrv","templateSrv"],t.prototype.testDatasource=function(){return new Promise((function(t,e){t({status:"success",message:"Compare Query Source is working correctly",title:"Success"})}))},t.prototype.query=function(t){var e=this,r=i.a.groupBy(t.targets,(function(t){return void 0===t.datasource.uid?t.datasource:t.datasource.uid})),n=i.a.groupBy(t.targets,"refId"),a=[];return i.a.forEach(r,(function(r,o){var u=i.a.cloneDeep(t),f=e.datasourceSrv.get(o).then((function(i){if(i.meta.id===e.meta.id)return e._compareQuery(t,r,n,e);u.targets=r;var a=i.query(u);return"function"==typeof a.toPromise?a.toPromise():a}));a.push(f)})),this.$q.all(a).then((function(t){return{data:i.a.flatten(i.a.filter(i.a.map(t,(function(t){var e=t.data;return e&&(e=i.a.filter(t.data,(function(t){return!0!==t.hide}))),e})),(function(t){return null!=t})))}}))},t.prototype._compareQuery=function(t,e,r,n){var a=[];return i.a.forEach(e,(function(e){var o=e.query;if(null!==o&&""!==o&&null!==r[o]){var f=i.a.cloneDeep(r[o][0]);if(f.hide=!1,f){var s=f.datasource;e.timeShifts&&e.timeShifts.length>0&&i.a.forEach(e.timeShifts,(function(r){var o,c,l=r.aliasType||"suffix",p=r.delimiter||"_",d=n.datasourceSrv.get(s).then((function(e){if(e.meta.id===n.meta.id)return{data:[]};if(o=n.templateSrv.replace(r.value,t.scopedVars),c=n.templateSrv.replace(r.alias,t.scopedVars)||o,null===o||""===o||void 0===o)return{data:[]};var a=i.a.cloneDeep(t);a.range.from=n.addTimeShift(a.range.from,o),a.range.to=n.addTimeShift(a.range.to,o),a.range.raw={from:a.range.from,to:a.range.to},a.rangeRaw=a.range.raw,f.refId=f.refId+"_"+o,a.targets=[f],a.requestId=a.requestId+"_"+o;var u=e.query(a);return"function"==typeof u.toPromise?u.toPromise():u})).then((function(t){var r=t.data;return r.forEach((function(t){if(t.target)t.target=n.generalAlias(t.target,c,l,p),void 0!==t.title&&null!==t.title&&(t.title=n.generalAlias(t.title,c,l,p));else if(t.fields)t.fields.forEach((function(t){t.name&&(t.name=n.generalAlias(t.name,c,l,p)),t.config&&t.config.displayName&&(t.config.displayName=n.generalAlias(t.config.displayName,c,l,p)),t.config&&t.config.displayNameFromDS&&(t.config.displayNameFromDS=n.generalAlias(t.config.displayNameFromDS,c,l,p))}));else if(t.columns)for(var r=1;r<t.columns.length;r++){var i=t.columns[r];i.text&&(i.text=n.generalAlias(i.text,c,l,p))}if(e.process){var a=n.parseShiftToMs(o);if("table"===t.type)t.rows&&t.rows.forEach((function(t){t[0]=t[0]+a}));else if(t.datapoints)t.datapoints.forEach((function(t){t[1]=t[1]+a}));else if(t.fields&&t.fields.length>0){var f=t.fields.find((function(t){return"time"===t.type}));if(f){var s={name:f.name,type:f.type,config:f.config||{},labels:f.labels,values:new u.ArrayVector};for(r=0;r<t.length;r++)s.values.set(r,f.values.get(r)+a);t.fields[0]=s}}}t.hide=e.hide})),{data:r}}));a.push(d)}))}}})),this.$q.all(a).then((function(t){return{data:i.a.flatten(i.a.filter(i.a.map(t,(function(t){var e=t.data;return e&&(e=i.a.filter(t.data,(function(t){return!0!==t.hide}))),e})),(function(t){return null!=t})))}}))},t.prototype.generalAlias=function(t,e,r,n){switch(r){case"prefix":return e+n+t;case"absolute":return e;case"suffix":default:return t+n+e}},t.prototype.parseShiftToMs=function(t){var e=this.parseTimeShift(t);if(e){var r=0-e.num,n=e.unit;if(i.a.includes(this.units,n)){var a=o()(),u=a.clone().add(r,n);return a.valueOf()-u.valueOf()}}},t.prototype.parseTimeShift=function(t){for(var e=t,r=t.length,n=0;n<r&&!isNaN(e.charAt(n));)if(++n>10)return;return{num:parseInt(e.substring(0,n),10),unit:e.charAt(n)}},t.prototype.addTimeShift=function(t,e){var r=this.parseTimeShift(e);if(r){var n=0-r.num,a=r.unit;return i.a.includes(this.units,a)?t.clone().add(n,a):void 0}},t}(),s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var c=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.aliasTypes=["suffix","prefix","absolute"],n.target.timeShifts||(n.target.timeShifts=[]),0===n.target.timeShifts.length&&n.addTimeShifts(),void 0===n.target.process&&(n.target.process=!0),n}return e.$inject=["$scope","$injector"],function(t,e){function r(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.targetBlur=function(){this.refresh()},e.prototype.onChangeInternal=function(){this.refresh()},e.prototype.addTimeShifts=function(){var t=this.getTimeShiftId();this.target.timeShifts.push({id:t})},e.prototype.removeTimeShift=function(t){if(!(this.target.timeShifts&&this.target.timeShifts.length<=1)){var e=i.a.indexOf(this.target.timeShifts,t);this.target.timeShifts.splice(e,1),this.refreshTimeShifts()}},e.prototype.refreshTimeShifts=function(){this.refresh()},e.prototype.onAliasAsChange=function(t){console.error("timeShift.aliasAs="+this.target.aliasAs),console.error("aliasAs="+t)},e.prototype.getTimeShiftId=function(){for(var t=0;;){if(i.a.every(this.target.timeShifts,(function(e){return e.id!==t})))return t;t++}},e.templateUrl="partials/query.editor.html",e}(r(3).QueryCtrl),l=function(){function t(){}return t.templateUrl="partials/config.html",t}();r.d(e,"Datasource",(function(){return f})),r.d(e,"QueryCtrl",(function(){return c})),r.d(e,"ConfigCtrl",(function(){return l}))}])}));
//# sourceMappingURL=module.js.map